stages:
    - build
    - deploy

variables:
    COMPOSER_HOME: "$CI_PROJECT_DIR/.composer"
    NO_PROXY: "gitlab.vtk.be"

# Build job
build:
    stage: build
    script:
        - echo "Starting Composer update and install..."
        - composer update --no-dev
        - composer install --no-dev
        - echo "Saving commit SHA to COMMIT file..."
        - echo "$CI_COMMIT_SHA" > COMMIT
        - echo "Creating tarball of project files..."
        - tar czf litus.tar.gz bin/ config/ data/ migrations/ module/ public/ shibboleth/ vendor/ COMMIT LICENSE.md NOTICE.md README.md
    only:
        - master
    cache:
        paths:
            - .composer/
            - vendor/
    artifacts:
        paths:
            - litus.tar.gz

# Common deploy settings
.deploy: &deploy
    stage: deploy
    before_script:
        - echo "Setting up SSH agent and adding key..."
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add -
    script:
        - echo "Setting Sentry log level to debug..."
        - export SENTRY_LOG_LEVEL=debug
        - echo "Copying tarball to remote host..."
        - scp -o StrictHostKeyChecking=no litus.tar.gz root@"$SSH_HOSTNAME":/tmp
        - echo "Running deployment script on remote host..."
        - ssh -o StrictHostKeyChecking=no root@"$SSH_HOSTNAME" /usr/local/sbin/deploy.sh
    only:
        - master
    when: manual
    dependencies:
        - build

# Deploy job for leia
deploy_leia:
    <<: *deploy
    variables:
        SSH_HOSTNAME: leia.vtk.be
    environment:
        name: leia
        url: https://liv.vtk.be

# Deploy job for liv
deploy_liv:
    <<: *deploy
    variables:
        SSH_HOSTNAME: liv.vtk.be
    environment:
        name: liv
        url: https://vtk.be
{% extends 'site/base.twig' %}

{% block content %}
    <div class="page-alert">
        <div class="flashmessage alert alert-success fade" id="entry_saved_success">
            <button type="button" class="close">&times;</button>
            <div class="content">
                {{ translate('Your entry has been recorded.') }}
            </div>
        </div>
        <div class="flashmessage alert alert-error fade" id="entry_saved_error">
            <button type="button" class="close">&times;</button>
            <div class="content">
                {{ translate('Your entry couldn\'t be recorded.') }}
            </div>
        </div>
    </div>

    <div class="page-header">
        <h1>{% if group %}{{ group.getTitle(language) }}: {% endif %}{{ specification.getTitle(language) }}</h1>
    </div>

    {% if group %}
        {% include 'form/form/partials/group-progress.twig' %}
    {% endif %}

    {% autoescape false %}
        {{ markdown(specification.getIntroduction(language)) }}
    {% endautoescape %}

    <hr/>

    {% if not form %}
        <div class="alert">
            {{ translate(message) }}
        </div>
    {% else %}
        {% if doodleNotValid %}
            <div class="flashmessage alert alert-error fade in">
                <a class="close" data-dismiss="alert">&times;</a>
                {{ translate('Your subscriptions couldn\'t be saved.') }}
            </div>
        {% endif %}
        {% do form.prepare() %}
        {% autoescape false %}{{ form().openTag(form) }}{% endautoescape %}
            {{ formElement(form.get('csrf')) }}
            <table class="table table-bordered table-striped" id="doodle">
                <tr>
                    <th>{{ translate('Date') }}</th>
                    <th width="240px">{{ translate('Location') }}</th>
                    <th width="250px">{{ translate('Info') }}</th>
                    <th width="130px">{{ translate('Subscribe') }}</th>
                </tr>
                {% for field in specification.getFields() %}
                    <tr {% if formElementErrors(form.get('field-' ~ field.getId())) %}class="error"{% endif %}>
                        <td>
                            {{ field.getLabel(language) }}
                        </td>
                        <td>
                            {{ field.getLocation(language) }}
                        </td>
                        <td>
                            {{ field.getExtraInformation(language)|slice(1, 30) }}
                            {% if field.getExtraInformation(language) %}
                                <a href="#" class="extraInformation pull-right" data-content="{{ field.getExtraInformation(language) }}"><i class="icon-info-sign"></i></a>
                            {% endif %}
                        </td>
                        <td>
                            {% if occupiedSlots[field.getId()] %}
                                {% if specification.getNamesVisibleForOthers() %}
                                    <i>{{ occupiedSlots[field.getId()] }}</i>
                                {% else %}
                                    <i>{{ translate('Occupied') }}</i>
                                {% endif %}
                            {% else %}
                                <label class="checkbox" style="margin: 2px 0">
                                    {{ formElement(form.get('field-' ~ field.getId())) }}
                                </label>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>

            {% if specification.canBeSavedBy(authenticatedPerson) %}
                <div class="form-actions">
                    <div class="row">
                        <span class="label"></span>
                        <span class="field">
                            {{ formElement(form.get('submit')) }}
                        </span>
                    </div>
                </div>
            {% endif %}
        {% autoescape false %}{{ form().closeTag() }}{% endautoescape %}
    {% endif %}
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('.flashmessage .close').click(function () {
                $(this).closest('.flashmessage').removeClass('in');
            });

            $('span[data-toggle=tooltip]').tooltip({'trigger': 'hover'});
            $('.extraInformation').popover({'trigger': 'hover'});

            $('#doodle label.checkbox').each(function () {
                $(this).hide();
                $(this).parent().append(
                    $('<button>', {'class': 'btn btn-primary btn-small doodleButton'}).html('{{ translate('Subscribe') }}').click(function (e) {
                        e.preventDefault();

                        if ($(this).is(':disabled'))
                            return false;

                        var checkbox = $(this).parent().find('input[type=checkbox]');

                        {% if not specification.isMultiple() %}
                            if (!checkbox.prop('checked')) {
                                $('#doodle .doodleButton').each(function () {
                                    toggleButton($(this), $(this).parent().find('input[type=checkbox]'), false);
                                });
                            }
                        {% endif %}

                        toggleButton($(this), checkbox, !checkbox.is(':checked'));

                        saveRegistration();
                    })
                );

                toggleButton($(this).parent().find('button'), $(this).find('input[type=checkbox]'), $(this).find('input[type=checkbox]').is(':checked'));

                $(this).parent().find('button').prop('disabled', $(this).find('input[type=checkbox]').is(':disabled'));
            });
        });

        function toggleButton(button, checkbox, value) {
            if (!value) {
                checkbox.prop('checked', false);
                button.html('{{ translate('Subscribe') }}').removeClass('btn-danger');
            } else {
                checkbox.prop('checked', true);
                button.html('{{ translate('Unsubscribe') }}').addClass('btn-danger');
            }
        }

        function saveRegistration() {
            var data = {};
            $('#doodle input[type=checkbox]').each(function () {
                if ($(this).is(':checked')) {
                    data[$(this).attr('name')] = true;
                }
            });

            $.post('{{ url('form_view', {'action': 'saveDoodle', 'id': specification.getId()}) }}', data, function (data) {
                if (data !== undefined && data.status == 'success') {
                    $('#entry_saved_error').removeClass('in');
                    $('#entry_saved_success').addClass('in');
                } else {
                    $('#entry_saved_success').removeClass('in');
                    $('#entry_saved_error').addClass('in');

                    $('#doodle tr.error').removeClass('error');
                    if (data !== undefined && data.errors) {
                        $.each(data.errors, function (key, value) {
                            console.log(key);
                            $('#' + key).closest('tr').addClass('error');
                        });
                    }
                }
            }, 'json').error(function (data) {
                $('#entry_saved_success').removeClass('in');
                $('#entry_saved_error').addClass('in');
            });
        }
    </script>
{% endblock %}
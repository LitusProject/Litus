{% extends 'site/base.twig' %}

{% block content %}
    {% import 'site/partials/form.twig' as forms %}

    <div class="flashmessage alert alert-success fade" id="responsible_success">
        <div class="content">
            {{ translate('You were signed up as a responsible for the selected shift!') }}
        </div>
    </div>
    <div class="flashmessage alert alert-success fade" id="responsible_success">
        <div class="content">
            {{ translate('You were signed up as a volunteer for the selected shift!') }}
        </div>
    </div>
    <div class="flashmessage alert alert-success fade" id="signout">
        <div class="content">
            {{ translate('You were singed out from the selected shift!') }}
        </div>
    </div>
    <div class="flashmessage alert alert-error fade" id="error">
        <div class="content">
            {{ translate('An error occurred while processing your request!') }}
        </div>
    </div>

    <div class="page-header">
        <h1>{{ translate('Shifts') }}</h1>
    </div>

    <div class="row-fluid">
        <span class="span4">
            <h2>{{ translate('Search') }}</h2>

            <div class="well well-small">
                <h4>{{ translate('By Event') }}</h4>

                {{ forms.renderForm(eventSearchForm) }}
            </div>

            <div class="well well-small">
                <h4>{{ translate('By Unit') }}</h4>

                {{ forms.renderForm(unitSearchForm) }}
            </div>
        </span>
        <span class="span8">
            <h2>{{ translate('My Shifts') }}</h2>
                {{ _self.displayShifts(entityManager, academicYear, authenticatedPerson, myShifts, 'myShifts') }}

            <h2>{{ translate('Results') }}</h2>
            {% if searchResults is not null %}
                {{ _self.displayShifts(entityManager, academicYear, authenticatedPerson, searchResults, 'search') }}
            {% else %}
                <div class="alert alert-warning">
                    {{ translate('There are no shifts to be shown yet; please use the search functions on the left.') }}
                </div>
            {% endif %}
        </span>
    </div>
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('.responsible').click(function () {
                var button = $(this);

                button.parent().find('button').each(function(i) {
                    $(this).addClass('active disabled');
                })

                var count = parseInt(button.data('count'), 10);

                $.post(
                    '{{ url('shift', {"action": "responsible"}) }}',
                    {"id": $(this).data('id'), "person": "{{ authenticatedPerson.getId() }}"},
                    function (data) {
                        if (data && 'success' == data.status) {
                            $('.flashmessage').removeClass('in');
                            $('#responsible_success').addClass('in');

                            updateButton(button, parseInt(data.ratio, 10), count);
                        } else {
                            errorSave();
                        }
                    },
                    'json'
                ).error(errorSave);
            });

            $('.volunteer').click(function () {
                var button = $(this);

                button.parent().find('button').each(function(i) {
                    $(this).addClass('active disabled');
                })

                var count = parseInt($(this).data('count'));

                $.post(
                    '{{ url('shift', {"action": "volunteer"}) }}',
                    {"id": $(this).data('id'), "person": "{{ authenticatedPerson.getId() }}"},
                    function (data) {
                        if (data && 'success' == data.status) {
                            $('.flashmessage').removeClass('in');
                            $('#responsible_volunteer').addClass('in');

                            updateButton(button, parseInt(data.ratio), count);
                        } else {
                            errorSave();
                        }
                    },
                    'json'
                ).error(errorSave);
            });

            $('.signout').click(function () {
                var button = $(this);
                button.addClass('active disabled');

                $.post(
                    '{{ url('shift', {"action": "signout"}) }}',
                    {"id": $(this).data('id'), "person": "{{ authenticatedPerson.getId() }}"},
                    function (data) {
                        if (data && 'success' == data.status) {
                            $('.flashmessage').removeClass('in');
                            $('#signout').addClass('in');

                            $(button.data('accordion')).fadeOut();
                        } else {
                            errorSave();
                        }
                    },
                    'json'
                ).error(errorSave);
            });
        });

        function updateButton(button, ratio, count) {
            button.removeClass('btn-success btn-warning btn-danger');

            if (ratio < 0.5) {
                button.addClass('btn-success');
            } else if (ratio < 0.75) {
                button.addClass('btn-warning');
            } else if (ratio == 1) {
                button.addClass('btn-danger');
            }

            button.find('.count').text(++count);
        }

        function errorSave() {
            $('.flashmessage').removeClass('in');
            $('#error').addClass('in');
        }
    </script>
{% endblock %}

{% macro displayShifts(entityManager, academicYear, authenticatedPerson, shifts, accordionName) %}
    <div class="accordion" id="shifts-{{ accordionName }}">
        {% for shift in shifts %}
            <div class="accordion-group" id="group_{{ accordionName }}_shift-{{ shift.getId() }}">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#shifts-{{ accordionName }}" href="#collapse_{{ accordionName }}_shift-{{ shift.getId() }}">
                        {{ shift.getStartDate().format('d/m/Y H:i') }}-{{ shift.getEndDate().format('H:i') }}&mdash;{{ shift.getName() }}

                        <span class="pull-right">
                            {% if 'search' == accordionName %}
                                {% if shift.canHaveAsResponsible(entityManager, academicYear, authenticatedPerson) and 0 != shift.getNbResponsibles() %}
                                    <button class="btn btn-mini {{ _self.buttonStyle(shift, 'responsibles') }} responsible" data-id="{{ shift.getId() }}" data-count="{{ shift.countResponsibles() }}" type="button">
                                        {{ translate('Responsible') }} (<span class="count">{{ shift.countResponsibles() }}</span>/{{ shift.getNbResponsibles() }})
                                    </button>
                                {% endif %}
                                {% if shift.canHaveAsVolunteer(entityManager, academicYear, authenticatedPerson) and 0 != shift.getNbVolunteers() %}
                                    <button class="btn btn-mini {{ _self.buttonStyle(shift, 'volunteers') }} volunteer" data-id="{{ shift.getId() }}" data-count="{{ shift.countVolunteers() }}" type="button">
                                        {{ translate('Volunteer') }} (<span class="count">{{ shift.countVolunteers() }}</span>/{{ shift.getNbVolunteers() }})
                                    </button>
                                {% endif %}
                            {% else %}
                                {% if shift.canSignout(entityManager, authenticatedPerson) %}
                                    <button class="btn btn-mini signout" data-id="{{ shift.getId() }}" data-accordion="#group_{{ accordionName }}_shift-{{ shift.getId() }}" type="button">
                                        {{ translate('Signout') }}
                                    </button>
                                {% endif %}
                            {% endif %}
                        </span>
                    </a>
                </div>
                <div id="collapse_{{ accordionName }}_shift-{{ shift.getId() }}" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <div class="row-fluid">
                            <span class="span8">
                                <div class="row-fluid">
                                    <span class="span6">
                                        <dl>
                                            <dt>{{ translate('Start') }}</dt>
                                            <dd>{{ shift.getStartDate().format('d/m/Y H:i') }}</dd>
                                            <dt>{{ translate('End') }}</dt>
                                            <dd>{{ shift.getEndDate().format('d/m/Y H:i') }}</dd>
                                        </dl>
                                    </span>

                                    <span class="span6">
                                        <dl>
                                            <dt>{{ translate('Manager') }}</dt>
                                            <dd>{{ shift.getManager().getFullName() }}</dd>

                                            {% if shift.getEvent() is not null %}
                                                <dt>{{ translate('Event') }}</dt>
                                                <dd>{{ shift.getEvent().getTitle(language) }}</dd>
                                            {% endif %}

                                            <dt>{{ translate('Unit') }}</dt>
                                            <dd>{{ shift.getUnit().getName() }}</dd>
                                        </dl>
                                    </span>
                                </div>
                                <div class="row-fluid">
                                    <span class="span12">
                                        <dl>
                                            <dt>{{ translate('Description') }}</dt>
                                            <dd style="text-align: justify;">{{ shift.getDescription() }}</dd>

                                            <dt>{{ translate('Location') }}</dt>
                                            <dd><img class="img-rounded" src="{{ staticMapUrl(shift.getLocation(), '367x125', '7a43b6') }}" /></dd>
                                        </dl>
                                    </span>
                                </div>
                            </span>
                            <span class="span4">
                                {% if 0 != shift.getNbResponsibles() %}
                                    <dl>
                                        <dt>{{ translate('Responsibles') }}</dt>

                                        {% for responsible in shift.getResponsibles() %}
                                            <dd>{{ responsible.getPerson().getFullName() }}</dd>
                                        {% endfor %}
                                    </dl>
                                {% endif %}

                                {% if 0 != shift.getNbVolunteers() %}
                                    <dl>
                                        <dt>{{ translate('Volunteers') }}</dt>

                                        {% for volunteer in shift.getVolunteers() %}
                                            <dd>{{ volunteer.getPerson().getFullName() }}</dd>
                                        {% endfor %}
                                    </dl>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                {% if 'search' == accordionName %}
                    {{ translate('No shifts were found that match the given query.') }}
                {% else %}
                    {{ translate('You have not yet signed up for any shifts. You can use the search functions on the left to look for some!') }}
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% endmacro %}

{% macro buttonStyle(shift, type) %}
    {% if 'responsibles' == type %}
        {% set ratio = shift.countResponsibles() / shift.getNbResponsibles() %}
    {% else %}
        {% set ratio = shift.countVolunteers() / shift.getNbVolunteers() %}
    {% endif %}

    {% if ratio < 0.5 %}
        btn-success
    {% elseif ratio < 0.75 %}
        btn-warning
    {% elseif ratio == 1 %}
        btn-danger
    {% endif %}
{% endmacro %}

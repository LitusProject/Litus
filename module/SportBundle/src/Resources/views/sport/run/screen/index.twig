{% extends 'run/base.twig' %}

{% block content %}
    <div class="page-header">
        <h1>Welcome!</h1>
    </div>

    <div class="row">
        <div class="span3 columns">
            <h2>Laps</h2>

            <p>
                We have run <span id="nbOfficialLaps" class="label important" style="font-size: 16px;">N/A</span> <span id="nbOfficialLapsText">laps</span>.
            </p>

            <h2>Runners</h2>

            <p>
                There <span id="uniqueRunnersTextVerb">have</span> been <span id="uniqueRunners" class="label success" style="font-size: 16px;">N/A</span> unique <span id="uniqueRunnersText">runners</span>.
            </p>

            <h2>Groups of Friends</h2>

            <p>
                The current groups ranking of the groups of friends.
            </p>

            <table class="zebra-striped">
                <thead>
                    <tr>
                        <th width="80%">Name</th>
                        <th width="20%">Points</th>
                    </tr>
                </thead>

                <tbody id="groups_of_friends">
                    <tr>
                        <td colspan="3"><i>There are no groups of friends!</i></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="span9 columns">
            <div class="row">
                <h2>Current Runner</h2>
                <div id="currentLap" class="well">
                    <p>
                        <span style="font-size: 18px;">
                            <strong id="currentLapRunnerName">
                                Nobody
                            </strong>
                        </span>
                    </p>

                    <div id="currentLapInfo" style="display: none">
                        <span id="currentLapTime"></span>,
                        <span id="officialSpeed">{% if officialResults is null %}N/A{% else %}{{ officialResults['speed'] }}{% endif %}</span></span> km/h

                        <div class="progress progress-striped active" style="margin-bottom: 0;">
                            <div class="bar" style="width: {{ officialResults['position'] }}%;"></div>
                        </div>
                    </div>
                </div>

                <div id="noCurrentLap" class="flashmessage alert alert-error fade">
                    <p>
                        <span style="font-size: 18px;">There is nobody running!</span>
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="span5">
                    <h3>Previous Runners</h3>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th width="10%">#</th>
                                <th width="60%">Runner</th>
                                <th width="30%">Lap Time</th>
                            </tr>
                        </thead>

                        <tbody id="previous_runners">
                            <tr>
                                <td colspan="3"><i>There are no previous runners!</i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="span4">
                    <h3>Next Runners</h3>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th width="10%">#</th>
                                <th width="90%">Runner</th>
                            </tr>
                        </thead>

                        <tbody id="next_runners">
                            <tr>
                                <td colspan="3"><i>There are no next runners!</i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        var counter;
        $(document).ready(function () {
            $(document).runQueue({
                url: '{{ socketUrl }}',
                errorDialog: $('#loading_queue_error'),
                displayLaps: displayLaps
            });

            setInterval(updateLapInfo, 1000)
        });

        function displayLaps(data) {
            $('#nbOfficialLaps').html(data.number.official);
            $('#nbOfficialLapsText').html((data.number.official == 1 ? 'lap' : 'laps'));
            $('#uniqueRunners').html(data.number.uniqueRunners);
            $('#uniqueRunnersText').html((data.number.uniqueRunners == 1 ? 'runner' : 'runners'));
            $('#uniqueRunnersTextVerb').html((data.number.uniqueRunners == 1 ? 'has' : 'have'));

            var foundCurrent = false;
            $('#previous_runners').html('');
            $('#next_runners').html('');

            $(data.laps).each(function (num, lap) {
                if (lap.state == 'current') {
                    var lapTime = parseInt(lap.lapTime.substring(0, lap.lapTime.indexOf(':')), 10) * 60 + parseInt(lap.lapTime.substring(lap.lapTime.indexOf(':') + 1), 10);

                    $('#noCurrentLap').removeClass('in');
                    $('#currentLapRunnerName').html(lap.fullName);
                    $('#currentLapInfo').show().data('lapTime', lapTime);
                    $('#currentLapTime').html(lap.lapTime);

                    foundCurrent = true;
                } else if (lap.state == 'previous') {
                    $('#previous_runners').prepend(
                        $('<tr>').append(
                            $('<td>').html(0),
                            $('<td>').html(lap.fullName),
                            $('<td>').html(lap.lapTime)
                        )
                    );
                } else if (lap.state == 'next') {
                    $('#next_runners').append(
                        $('<tr>').append(
                            $('<td>').html($('#next_runners tr').length + 1),
                            $('<td>').html(lap.fullName)
                        )
                    );
                }
            });

            var counter = 1;
            $('#previous_runners tr').each(function () {
                $(this).find('td:first').html(counter++);
            });

            if ($('#previous_runners tr').length == 0)
                $('#previous_runners').html('<tr><td colspan="3"><i>There are no previous runners!</i></td></tr>');
            if ($('#next_runners tr').length == 0)
                $('#next_runners').html('<tr><td colspan="3"><i>There are no next runners!</i></td></tr>');

            if (!foundCurrent) {
                $('#currentLapRunnerName').html('Nobody');
                $('#noCurrentLap').addClass('in');
                $('#currentLapInfo').hide();
            }
        }

        function updateLapInfo() {
            if (!$('#currentLapInfo').is(':visible'))
                return;

            var lapTime = $('#currentLapInfo').data('lapTime');
            lapTime++;
            $('#currentLapInfo').data('lapTime', lapTime);
            $('#currentLapTime').html(Math.floor(lapTime / 60) + ':' + (lapTime % 60 < 10 ? "0" + lapTime % 60 : lapTime % 60));
        }
        /*setInterval(function() {
                $.getJSON('<?= $this->url(array('action' => 'update')); ?>?format=json', function(data) {
                    if (false != data.currentLap) {
                        $('#noCurrentLap').fadeOut('slow', function() {
                            $('#currentLap').fadeIn('slow');
                        });

                        $('#currentLapRunnerName').text(data.currentLap.runnerName);
                        $('#currentLapTime').text(data.currentLap.time);
                    } else {
                        $('#currentLap').fadeOut('slow', function() {
                            $('#noCurrentLap').fadeIn('slow');
                        });
                    }

                    if (0 != data.previousLaps.length) {
                        $('#previous_runners').empty();

                        $.each(data.previousLaps, function(lapNb, previousLap) {
                            $('#previous_runners').append('<tr><td>' + previousLap.id + '</td><td>' + previousLap.runner + '</td><td>' + previousLap.time + '</td></tr>')
                        });
                    }

                    if (0 != data.nextLaps.length) {
                        $('#next_runners').empty();

                        $.each(data.nextLaps, function(lapNb, nextLap) {
                            $('#next_runners').append('<tr><td>' + nextLap.id + '</td><td>' + nextLap.runner + '</td></tr>')
                        });
                    }

                    if (false != data.officialResults) {
                        $('#nbOfficialLaps').html(data.officialResults.nbLaps);

                        $('#nbOfficialLapsText').html(
                            data.officialResults.nbLaps == 1 ? 'lap' : 'laps'
                        );

                        $('#officialPosition').html(Math.round(data.officialResults.position * 100, 2));
                        $('#officialSpeed').html(data.officialResults.speed);
                    } else {
                        $('#nbOfficialLaps').html('N/A');

                        $('#nbOfficialLapsText').html('laps');

                        $('#officialPosition').html('N/A');
                        $('#officialSpeed').html('N/A');
                    }

                    $('#uniqueRunners').html(data.uniqueRunners);
                    uniqueRunnersText = data.uniqueRunners == 1 ? 'runner' : 'runners';
                    $('#uniqueRunnersText').html(uniqueRunnersText);

                    if (0 != data.groupsOfFriends.length) {
                        $('#groups_of_friends').empty();

                        $.each(data.groupsOfFriends, function(groupNb, group) {
                            $('#groups_of_friends').append('<tr><td>' + group.name + '</td><td>' + group.points + '</td></tr>')
                        });
                    }
                })
            },
            1000
        );*/
    </script>
{% endblock %}
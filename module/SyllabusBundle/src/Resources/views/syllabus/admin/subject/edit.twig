{% extends 'admin/base.twig' %}

{% block content %}
	{% include 'syllabus/admin/study/partials/navigation.twig' %}

	{% include 'admin/partials/flashMessenger.twig' %}

	<div class="flashmessage success_message full_width mapping_removed_success hide">
		<div class="title">Success</div>
		<div class="content">
			<p>The mapping was successfully removed!</p>
		</div>
	</div>
	<div class="flashmessage error_message full_width mapping_removed_error hide">
		<div class="title">Error</div>
		<div class="content">
			<p>An error occurred while trying to delete the mapping.</p>
		</div>
	</div>

	{% include 'syllabus/admin/study/partials/years.twig' %}

	<div id="controller_action">
	    <h1>Subject</h1>

	    <p>Code: <b>{{ subject.getCode() }}</b></p>
	    <p>Name: <b>{{ subject.getName() }}</b></p>
	    <p>Semester: <b>{{ subject.getSemester() }}</b></p>
	    <p>Credits: <b>{{ subject.getCredits() }}</b></p>
	    <p>Students: <b>{{ subject.getNbEnrollment(currentAcademicYear) }}</b></p>
	    <br />

		<div>
		    <h1>Docents</h1>
			<table class="manage">
		        <tr>
		            <th width="90px">Identification</th>
		            <th>Name</th>
		            <th width="70px">Actions</th>
		        </tr>

		        {% for mapping in profMappings %}
		            <tr class="item item-{{ mapping.getId() }}">
		                <td>{{ mapping.getProf().getUniversityIdentification() }}</td>
		                <td>{{ mapping.getProf().getFullName() }}</td>
		                <td class="actions">
		                    {% if hasAccess('admin_prof', 'delete') %}
		                        <a href="#" data-id="{{ mapping.getId() }}" data-docent="{{ mapping.getProf().getFullName() }}" data-subject="{{ subject.getName() }}" class="delete">Delete</a>
		                    {% endif %}
		                </td>
		            </tr>
		        {% endfor %}
		    </table>
		    <h1>Articles</h1>
		    <table>
		        <tr>
		            <th>Title</th>
		            <th width="100px">Author</th>
		            <th width="180px">Publisher</th>
		            <th width="50px">Year</th>
		            <th width="60px">Type</th>
		        </tr>

		        {% for mapping in articleMappings %}
		            <tr class="item">
		                <td>{{ mapping.getArticle().getTitle() }}</td>
		                <td>{{ mapping.getArticle().getAuthors() }}</td>
		                <td>{{ mapping.getArticle().getPublishers() }}</td>
		                <td>{{ mapping.getArticle().getYearPublished() }}</td>
		                <td>{% if mapping.getArticle().isInternal() %}Internal{% else %}External{% endif %}</td>
		            </tr>
		        {% endfor %}
		    </table>
		</div>
	</div>

	<aside>
	    {% if hasAccess('admin_prof', 'add') %}
			<div class="sidebox">
			    <div class="title">Add Docent</div>
			    <div class="content">
			        <p>
			            <i>Please hit the link below to add a docent to this subject!</i>
			        </p>
			    	<p>
			    		<a href="{{ url("admin_prof", {"action": "add", "id": subject.getId(), "academicyear": currentAcademicYear.getCode()}) }}">&rarr; Add Docent</a>
			    	</p>
			    </div>
			</div>
		{% endif %}
		{% if hasAccess('admin_subject_comment', 'manage') %}
			<div class="sidebox">
			    <div class="title">View Comments</div>
			    <div class="content">
			        <p>
			            <i>Please hit the link below to view the comments to this subject!</i>
			        </p>
			    	<p>
			    		<a href="{{ url("admin_subject_comment", {"action": "manage", "id": subject.getId()}) }}">&rarr; View Comments</a>
			    	</p>
			    </div>
			</div>
		{% endif %}
	</aside>

	<div class="modal hide fade" id="removeMapping">
		<div class="modal-header">
			<span>Litus Admin</span>
			/Delete Docent
		</div>
		<div class="modal-body">
			<p>
				You are about to delete the following mapping: <b class="subjectTitle"></b> with <b class="docentName"></b>!
				Please note that this operation cannot be undone!
			</p>
			<p>
				Are you sure you want to continue?
			</p>
			<div class="footer">
				<input type="button" class="delete" value="Yes">
				<input type="button" class="cancel" data-dismiss="modal" value="No">
			</div>
		</div>
	</div>
{% endblock %}

{% block content_script %}
	<script type="text/javascript">
		$(document).ready(function () {
			$('.item .delete').click(openModal);
		});

		function openModal(e) {
			var $this = $(this);

			e.preventDefault();
			var removeMapping = $('#removeMapping');
			removeMapping.find('.subjectTitle').html($(this).data('subject'));
			removeMapping.find('.docentName').html($(this).data('docent'));
			var id = $this.data('id');
			removeMapping.find('.delete').unbind('click').click(function () {
				$.post('{{ url('admin_prof', {"action": "delete"})}}' + id, function (data) {
				    if (data && 'success' == data.status) {
    					$('.flashmessage').addClass('hide');
    					$('.mapping_removed_success').removeClass('hide');
						$('.item-' + id).remove();
    					removeMapping.modal('hide');
    				} else {
    				    errorRemove();
    				}
				}, 'json').error(errorRemove);
			});
			removeMapping.modal();
		}

		function errorRemove() {
    		$('.flashmessage').addClass('hide');
    		$('.mapping_removed_error').removeClass('hide');
    		$('#removeMapping').modal('hide');
		}
	</script>
{% endblock %}

{% extends 'sale/base.twig' %}
{% set showHeader = 0 %}

{% block content %}
    <div class="alert alert-danger fade show" id="loadingQueueError">
        An error occurred while loading the queue.
    </div>

    <div class="row">
        <div class="col-12">
            <table class="w-100">
                <tr>
                    {% for payDesk in payDesks %}
                        <td class="p-3">
                            <h3>{{ payDesk.getName() }}</h3>
                            <table class="table table-striped paydesk" id="paydesk{{ payDesk.getId() }}">
                                <tr>
                                    <td></td>
                                    <td><i>No Customer</i></td>
                                </tr>
                            </table>
                        </td>
                    {% endfor %}
                </tr>
            </table>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h2>Queue</h2>
        </div>
    </div>

    <div class="row">
        <div class="{% if enableCollecting %}col-4{% else %}col-6{% endif %}">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Collected</th>
                    </tr>
                </thead>
                <tbody class="queueList" id="collectedList">
                </tbody>
            </table>
        </div>
        <div class="col-4 {% if not enableCollecting %}d-none{% endif %}">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Collecting</th>
                    </tr>
                </thead>
                <tbody class="queueList" id="collectingList">
                </tbody>
            </table>
        </div>
        <div class="{% if enableCollecting %}col-4{% else %}col-6{% endif %}">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Signed In</th>
                    </tr>
                </thead>
                <tbody class="queueList" id="signedInList">
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $.webSocket(
                {
                    name: 'overviewQueue',
                    url: '{{ socketUrl }}',
                    open: function (e) {
                        $('#loadingQueueError').addClass('d-none').removeClass('fade show');
                        $.webSocket('send', {name: 'overviewQueue', text:
                            JSON.stringify({
                                'command': 'initialize',
                                'queueType': 'queue',
                                'session': '{{ session.getId() }}',
                                'key': '{{ key }}',
                                'authSession': '{{ authSession.getId() }}',
                            })
                        });
                    },
                    message: function (e, data) {
                        $('#loadingQueueError').addClass('d-none').removeClass('fade show');

                        displayItem($('#signedInList'), data.queue.signed_in);
                        displayItem($('#collectingList'), data.queue.collecting);
                        displayItem($('#collectedList'), data.queue.collected);

                        $('.paydesk').html(
                            $('<tr>').append(
                                $('<td>'),
                                $('<td>').append(
                                    $('<i>').html('No Customer')
                                )
                            )
                        );

                        $(data.queue.selling).each(function () {
                            $('#paydesk' + this.payDeskId).html(
                                $('<tr>').append(
                                    $('<td>').html(this.number),
                                    $('<td>').append(
                                        (this.name ? this.name : 'guest ' + this.id)
                                    )
                                )
                            );
                        });
                    },
                    error: function (e) {
                        $('#loadingQueueError').addClass('fade show').removeClass('d-none');
                        $('.queueList').html('');
                    }
                }
            );
        });

        function displayItem(container, data) {
            container.html('');
            $(data).each(function () {
                var item = $('<tr>').append(
                        $('<th scope="col">').html(this.number),
                        $('<td>').append(
                            (this.name ? this.name : 'Guest ' + this.id),
                            ' ',
                            (this.payDesk ? $('<span>', {class: 'badge badge-primary'}).html(this.payDesk) : '')
                        )
                    );
                container.append(item);
            });
        }
    </script>
{% endblock %}

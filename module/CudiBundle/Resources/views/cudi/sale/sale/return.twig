{% extends 'sale/base.twig' %}

{% block content %}
    <div class="flashmessage alert alert-info fade" id="returnMessage">
        <a class="close">&times;</a>
        {% autoescape false %}{{ translate('You have to return this customer <b class="price"></b>.') }}{% endautoescape %}
    </div>

    {% import 'site/partials/form.twig' as forms %}
    {{ forms.renderForm(form) }}
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('.flashmessage .close').click(function () {
                $(this).closest('.flashmessage').removeClass('in');
            });

            $('#person').typeaheadRemote(
                {
                    source: '{{ url("common_admin_academic_typeahead")}}',
                }
            ).change(function (e) {
                if ($(this).data('value')) {
                    $('[name="person[id]"]').val($(this).data('value').id);
                    searchPrice();
                } else {
                    $('[name="person[id]"]').val('');
                }
            });

            $('#article').typeaheadRemote(
                {
                    source: '{{ url("cudi_admin_sales_article_typeahead", {"academicyear": currentAcademicYear.getCode() })}}',
                }
            ).change(function (e) {
                if ($(this).data('value')) {
                    $('[name="article[id]"]').val($(this).data('value').id);
                    searchPrice();
                } else {
                    $('[name="article[id]"]').val('');
                }
            });
        });

        function searchPrice() {
            {% if hasAccess('cudi_sale_sale', 'returnPrice') %}
            if ($('[name="article[id]"]').val() != '' && $('[name="person[id]"]').val() != '') {
                $.post('{{ url('cudi_sale_sale', {'action': 'returnPrice', "session": session.getId()}) }}', {'person': $('[name="article[id]"]').val(), 'article': $('[name="person[id]"]').val()}, function (data) {
                    if (data !== undefined && data.price) {
                        $('#returnMessage .price').html('&euro; ' + (data.price/100).toFixed(2));
                        $('#returnMessage').addClass('in');
                    } else {
                        $('#returnMessage').removeClass('in');
                    }
                }, 'json');
            }
            {% endif %}
        }
    </script>
{% endblock %}

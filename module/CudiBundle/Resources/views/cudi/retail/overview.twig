{% extends 'site/base.twig' %}

{% block content %}
    {% import _self as self %}

    <div class="flashmessage alert alert-success fade" id="retail_success">
        <div class="content">
            {{ translate('You sent out a mail for the selected retail!') }}
        </div>
    </div>
    <div class="flashmessage alert alert-success fade" id="sign_out">
        <div class="content">
            {{ translate('You canceled your interest in the selected retail!') }}
        </div>
    </div>
    <div class="flashmessage alert alert-danger fade" id="error">
        <div class="content">
            {{ translate('An error occurred while processing your request!') }}
        </div>
    </div>

    <div id="modalSignInWarning" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h4>{{ translate('Sign Up') }}</h4>
                </div>
                <div class="modal-body">
                    <p>
                        {{ translate('You are about to sign up for a retail sale. A mail will be sent out to the seller. Do you want to continue?') }}
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary confirm">{{ translate('Yes') }}</button>
                    <button class="btn btn-default deny">{{ translate('No') }}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="page-header">
        <h1>{{ translate('Second-Hand Book Sales') }}</h1>
    </div>

    <div style="text-align: justify;">
        {{ translate('Here you can sign up for the inter-student second-hand book store') }}
    </div>

    <div class="row">
        <div class="col-md-4 bookSearchForms">
            <h2>{{ translate('Search') }}</h2>

            <div class="well">
                <h4>{{ translate('By Book') }}</h4>

                {% if bookSearchForm is defined %}
                    {% do bookSearchForm.prepare() %}
                    {% autoescape false %}
                        {{ form().openTag(bookSearchForm) }}

                        <div class="form-group">
                            <div class="input-group">
                                {{ formElement(bookSearchForm.get('search_string')) }}
                                <div class="input-group-btn">
                                    <button class="btn btn-default" type="submit">{{ translate('Search') }}</button>
                                </div>
                            </div>
                        </div>

                        {{ form().closeTag() }}
                    {% endautoescape %}
                {% endif %}
            </div>
        </div>
        <div class="col-md-8">
            {{ self.displayDeals(entityManager, authenticatedPerson, myDeals, 'myDeals') }}

            <h2>{{ resultString }}</h2>
            {% if searchResults is not null %}
                {{ self.displayRetails(entityManager, authenticatedPerson, searchResults, 'search') }}
            {% else %}
                <div class="alert alert-warning">
                    {{ translate('There are no Deals to be shown yet; please use the search function on the left.') }}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content_script %}
    {% import _self as self %}

    <script type="text/javascript">
        $(document).ready(function () {
            $('.retail').click(function () {
                let button = $(this);

                if (!button.hasClass('disabled')) {
                    let id = '#modalSignInWarning';
                    $(id).modal();
                    $(id +' .confirm').one('click', function (){
                        $(id).modal('hide');
                        enquireDeal(button);
                    });
                }

                button.parent().find('button').each(function(i) {
                    $(this).addClass('disabled');
                });

                $(id +' .deny').one('click', function () {
                    $(id).modal('hide');

                    button.parent().find('button').each(function(i) {
                        $(this).removeClass('disabled');
                    });
                });
            });

            {#$('.signOut').click(function () {#}
            {#    var button = $(this);#}
            {#    button.addClass('disabled');#}

            {#    $.post(#}
            {#        '{{ url('shift', {"action": "signOut"}) }}',#}
            {#        {"id": $(this).data('id')},#}
            {#        function (data) {#}
            {#            if (data && 'success' == data.status) {#}
            {#                $('.flashmessage').removeClass('in');#}
            {#                $('#sign_out').addClass('in');#}

            {#                var panel = $(button.data('panel')).clone();#}
            {#                panel.find('.buttons').html('').css('display', 'none');#}

            {#                $('#shifts-search .alert').remove();#}
            {#                $('#shifts-search').prepend(panel);#}
            {#                panel.fadeIn();#}
            {#                $('#shifts-myShifts ' + button.data('panel')).fadeOut(function () {$(this).remove()});#}
            {#            } else {#}
            {#                errorSave();#}
            {#            }#}
            {#        },#}
            {#        'json'#}
            {#    ).error(errorSave);#}
            {#});#}
        });

        function errorSave() {
            $('.flashmessage').removeClass('in');
            $('#error').addClass('in');
        }

        function enquireDeal(button) {
            $.post(
                '{{ url('cudi_retail', {"action": "deal"}) }}',
                {"id": button.data('id')},
                function (data) {
                    if (data && 'success' === data.status) {
                        $('.flashmessage').removeClass('in');
                        $('#deal_success').addClass('in');

                        var panel = $(button.data('panel')).clone();
                        panel.find('.buttons').html('').css('display', 'none');

                        $('#deals-myDeals .alert').remove();
                        $('#deals-myDeals').prepend(panel);
                        panel.fadeIn();
                        $('#retails-search ' + button.data('panel')).fadeOut(function () {$(this).remove()});
                    } else {
                        errorSave();
                    }
                },
                'json'
            ).error(errorSave);
        }

    </script>
{% endblock %}

{% macro displayDeals(entityManager, authenticatedPerson, deals, accordionName) %}
    {% import _self as self %}
    <div class="panel-group" id="deals-{{ accordionName }}">
        {% for deal in deals %}
            <div class="panel panel-default" id="group_{{ accordionName }}_deal-{{ deal.getId() }}">
                <div class="panel-heading">
                    <span class="buttons pull-right hidden-xs hidden-sm">
                        {{ self.buttons(entityManager, authenticatedPerson, deal, accordionName) }}
                    </span>
                    <a class="panel-toggle" data-toggle="collapse" data-parent="#deals-{{ accordionName }}" href="#collapse_{{ accordionName }}_deal-{{ deal.getId() }}" style="overflow: hidden;">
                        {{ deal.getRetail().getArticle().getTitle() }} <br> €{{ deal.getRetail().getPrice() }}  |  {{ deal.getRetail().getOwner().getFullName() }}
                    </a>
                </div>
                <div id="collapse_{{ accordionName }}_deal-{{ deal.getId() }}" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="buttons hidden-md hidden-lg" style="text-align: right">
                            {{ self.buttons(entityManager, authenticatedPerson, deal, accordionName) }}
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <dl>
                                    <dt>{{ translate('Book') }}</dt>
                                    <dd>{{ deal.getRetail().getArticle().getTitle() }}</dd>
                                    <dt>€{{ translate('Price') }}</dt>
                                    <dd>{{ deal.getRetail().getPrice() }}</dd>
                                    <dt>{{ translate('Seller') }}</dt>
                                    <dd>{{ deal.getRetail().getOwner().getFullName() }}</dd>
                                </dl>
                            </div>
                        </div>
                        <dl>
                            <dt>{{ translate('Description') }}</dt>
                            <dd style="text-align: justify;">{{ deal.getRetail().getComment() }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                {{ translate('No deals were found that match the given query.') }}
            </div>
        {% endfor %}
    </div>
{% endmacro %}

{% macro displayRetails(entityManager, authenticatedPerson, retails, accordionName) %}
    {% import _self as self %}

    <div class="panel-group" id="retails-{{ accordionName }}">
        {% for retail in retails %}
            <div class="panel panel-default" id="group_{{ accordionName }}_retail-{{ retail.getId() }}">
                <div class="panel-heading">
                    <span class="buttons pull-right hidden-xs hidden-sm">
                        {{ self.buttons(entityManager, authenticatedPerson, retail, accordionName) }}
                    </span>
                    <a class="panel-toggle" data-toggle="collapse" data-parent="#retails-{{ accordionName }}" href="#collapse_{{ accordionName }}_retail-{{ retail.getId() }}" style="overflow: hidden;">
                        {{ retail.getArticle().getTitle() }} <br> €{{ retail.getPrice() }}  |  {{ retail.getOwner().getFullName() }}
                    </a>
                </div>
                <div id="collapse_{{ accordionName }}_retail-{{ retail.getId() }}" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="buttons hidden-md hidden-lg" style="text-align: right">
                            {{ self.buttons(entityManager, authenticatedPerson, retail, accordionName) }}
                        </div>
                        <div class="row">
                            <div class="col-sm-10">
                                <dl>
                                    <dt>{{ translate('Book') }}</dt>
                                    <dd>{{ retail.getArticle().getTitle() }}</dd>
                                    <dt>{{ translate('Price') }}</dt>
                                    <dd>€{{ retail.getPrice() }}</dd>
                                    <dt>{{ translate('Seller') }}</dt>
                                    <dd>{{ retail.getOwner().getFullName() }}</dd>
                                </dl>
                            </div>
                        </div>
                        <dl>
                            <dt>{{ translate('Description') }}</dt>
                            <dd style="text-align: justify;">{{ retail.getComment() }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                {{ translate('You have not yet inquired about any retails!') }}
            </div>
        {% endfor %}
    </div>
{% endmacro %}


{% macro buttons(entityManager, authenticatedPerson, retail, accordionName) %}
    {% import _self as self %}

    {% if 'search' == accordionName %}
        <button class="btn btn-default btn-xs retail" data-id="{{ retail.getId() }}" data-panel="#group_{{ accordionName }}_retail-{{ retail.getId() }}" type="button">
            {{ translate('Enquire') }}
        </button>

    {% else %}
            <button class="btn btn-default btn-xs signOut" data-id="{{ deal.getId() }}" data-panel="#group_{{ accordionName }}_deal-{{ deal.getId() }}" type="button">
                {{ translate('Sign Out') }}
            </button>
    {% endif %}
{% endmacro %}

{% extends 'logistics/base.twig' %}

{% block content %}

    <div class="flashmessage alert alert-error fade in load_error hide">
        <a class="close" data-dismiss="alert">&times;</a>
        <div class="title">Error loading reservations</div>
        <div class="content">
            <p>There was an error while loading the reservations.</p>
        </div>
    </div>

	<div id="calendar"></div>
	<div id="debug"></div>
	
{% endblock %}

{% block content_script %}

	<script type="text/javascript">
		$(document).ready(function() {
		
			var date = new Date();
			var d = date.getDate();
			var m = date.getMonth();
			var y = date.getFullYear();
			
			$('#calendar').fullCalendar({
				header: {
					left: 'prev,next today',
					center: 'title',
					right: 'month,agendaWeek,agendaDay'
				},
				theme: false,
				editable: false,
				slotMinutes: 15,
				theme: true,
				allDaySlot: false,
				allDayDefault: false,

			    eventSources: [
			
			        {
			            events: function(start, end, callback) {
			            
	                		$('.load_error').addClass('hide');
			            
							// Use UNIX Timestamps
                			start = Math.round(start.getTime() / 1000);
                			end = Math.round(end.getTime() / 1000);
                			
							$.post('{{ url('logistics_reservation_fetch', {}) }}/' + start + '/' + end, function (data) {
							    if (data && 'success' == data.status) {
							    	reservations = data.reservations;

							    	var events = [];
							    	for (index in reservations) {
							    	
							    		$('#debug').append('Event<br/>');
							    		$('#debug').append('Title = ' + reservations[index].reason + '<br/>');
							    		$('#debug').append('Start = ' + reservations[index].start + '<br/>');
							    		$('#debug').append('End = ' + reservations[index].end + '<br/>');
							    	
							    		events.push({
					                        title: reservations[index].reason,
					                        start: reservations[index].start,
					                        end: reservations[index].end,
					                    });
							    	}
							    	
							    	callback(events);
							    	
			    				} else {
			    				    errorFetch();
			    				}
							}, 'json').error(errorFetch);

			            }
			        }
			
			    ],
			    
			    loading : function(isLoading, view) {
			    	if (isLoading) {
	    	    		$('#calendar').addClass('loading');
			    	} else {
			    		$('#calendar').removeClass('loading');
			    	}
			    }
			
			});

		});
		
		function errorFetch() {
    		$('.flashmessage').addClass('hide');
    		$('#calendar').removeClass('loading');
    		$('.load_error').removeClass('hide');
		}
		
	</script>
{% endblock %}